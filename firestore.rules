// Firestore security rules for FamSync
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function requesterFamilyId() {
      return isSignedIn() ? userDoc(request.auth.uid).data.familyId : null;
    }

    function isSameFamily(familyId) {
      return isSignedIn() && requesterFamilyId() == familyId;
    }

    function requesterRole() {
      return isSignedIn() ? userDoc(request.auth.uid).data.role : null;
    }

    // Users
    match /users/{uid} {
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow read: if isSignedIn() && (
        uid == request.auth.uid ||
        resource.data.familyId == requesterFamilyId()
      );
      allow update: if isSignedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    // Families root
    match /families/{familyId} {
      allow create: if isSignedIn() &&
        (request.resource.data.memberUids is list) &&
        (request.auth.uid in request.resource.data.memberUids);
      allow read: if isSameFamily(familyId);
      allow update: if isSignedIn() && (
        isSameFamily(familyId) ||
        ((request.resource.data.memberUids is list) &&
         (request.auth.uid in request.resource.data.memberUids))
      );
      allow delete: if isSameFamily(familyId) && requesterRole() == 'parent';

      // Announcements
      match /announcements/{id} {
        allow read: if isSameFamily(familyId);
        allow create: if isSameFamily(familyId) && requesterRole() == 'parent';
        allow delete: if isSameFamily(familyId) && requesterRole() == 'parent';
        allow update: if false;
      }

      // Messages
      match /messages/{id} {
        allow read: if isSameFamily(familyId);
        allow create: if isSameFamily(familyId);
        allow delete: if isSameFamily(familyId) && resource.data.authorUid == request.auth.uid;
        allow update: if false;
      }
      
      // Tasks & Chores
      match /tasks/{id} {
        allow read: if isSameFamily(familyId);
        allow create: if isSameFamily(familyId);
        allow update: if isSameFamily(familyId);
        allow delete: if isSameFamily(familyId);
      }

      // Events are now nested under families for better security
      // This prevents users from seeing events from other families
      match /events/{id} {
        allow read: if isSameFamily(familyId);
        allow create: if isSameFamily(familyId);
        allow update: if isSameFamily(familyId);
        allow delete: if isSameFamily(familyId);
      }
    }
  }
}
